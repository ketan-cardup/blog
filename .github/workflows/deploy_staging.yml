name: Staging Deployment
on: workflow_dispatch
jobs:
  deploy:
    name: Capistrano Deploy to Server
    runs-on: ubuntu-latest
    environment: staging
    env:
      SERVER_IP: ${{ secrets.SSH_HOST }}
      DEPLOY_DIGITAL_OCEAN: '~/.ssh/deploy-digital-ocean'
    steps:
    - name: Install SSH key to Server for Deploy User
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.DEPLOY_DIGITAL_OCEAN }}
        name: deploy-digital-ocean
        known_hosts: unnecessary

    - name: Install SSH key to Server for Github access via Capistrano
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_KEY_FOR_GITHUB_ACTIONS }}
        name: github-actions
        known_hosts: unnecessary

    - name: Adding Known Hosts
      run: ssh-keyscan -H ${{ secrets.SSH_HOST }}

    - name: Checkout Repo
      uses: actions/checkout@v2

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.7.2
        bundler-cache: true # runs 'bundle install' and caches installed gems automatically

    - name: Deploy to staging
      run: |
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/deploy-digital-ocean
        ssh-add ~/.ssh/github-actions
        bundle exec cap staging deploy
